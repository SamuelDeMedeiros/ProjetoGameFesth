@model IEnumerable<ProjetoE_CommerceGameFesth.Models.Produto>

@{
    ViewData["Title"] = "Carrinho";
    decimal total = 0;
}

<title>@ViewData["Title"] - ProjetoE_CommerceGameFesth</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f8f9fa;
        color: #333;
    }

    .title-doc {
        font-weight: 600;
        margin-bottom: 20px;
        position: relative;
    }

        .title-doc::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -10px;
            height: 3px;
            width: 50px;
            background-color: #007bff;
            border-radius: 2px;
        }

    .card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .empty-cart {
        text-align: center;
        margin: 50px 0;
    }

        .empty-cart svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }

        .empty-cart p {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 20px;
        }

    .total-value {
        font-size: 1.2rem;
        font-weight: 600;
        text-align: right;
        margin-top: 20px;
    }

    .btn-acao-primario {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

        .btn-acao-primario:hover {
            background-color: #0056b3;
        }

    .btn-continuar-comprando {
        width: 100%;
        padding: 10px 0;
        font-weight: 600;
        border-radius: 50px;
    }
</style>

<div class="container">
    <section id="order">
        <br />
        <h2 class="title-doc">Carrinho de compras</h2>

        <div id="code_cart">
            <div class="card p-3">
                @if (!Model.Any())
                {
                    <div class="empty-cart">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-2 5m5-5V6a1 1 0 112 0v7m0 5a1 1 0 11-2 0v-1h2v1zm4-5V6a1 1 0 112 0v7m0 5a1 1 0 11-2 0v-1h2v1z" />
                        </svg>
                        <p>Carrinho está vazio</p>
                    </div>
                }
                else
                {
                    <table class="table table-hover shopping-cart-wrap">
                        <thead class="text-muted">
                            <tr>
                                <th scope="col">Produtos</th>
                                <th scope="col" width="120">Preço</th>
                                <th scope="col" width="120">Quantidade</th>
                                <th scope="col" width="120">Subtotal</th>
                                <th scope="col" width="200" class="text-end">Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                var subTotal = item.Quantidade * Convert.ToDecimal(item.Valor);
                                total += subTotal;
                                <tr>
                                    <td>
                                        <figure class="media">
                                            <div class="img-wrap">
                                                <img alt="Thumbnail" src="@item.ImagemProduto" class="img-fluid" style="width: 80px; height: 80px; object-fit: cover;">
                                            </div>
                                            <figcaption class="media-body">
                                                <h6 class="title text-truncate">@item.NomeProduto</h6>
                                                <dl class="dlist-inline small">
                                                    <dt>Art.Nu: @item.Codbarras</dt>
                                                </dl>
                                            </figcaption>
                                        </figure>
                                    </td>
                                    <td>
                                        <div class="price-wrap">
                                            <var class="price">@item.Valor</var>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                @if (item.Quantidade > 1)
                                                {
                                                    @using (Html.BeginForm("DiminuirItem", "Home", FormMethod.Post))
                                                    {
                                                        <input type="hidden" name="id" value="@item.Codbarras">
                                                        <input type="hidden" name="quantidade" value="1">
                                                        <button type="submit" class="btn btn-default btn-acao-primario">-</button>
                                                    }
                                                }
                                                else
                                                {
                                                    <button type="button" class="btn btn-default btn-acao-primario" onclick="confirmRemove('@item.Codbarras')">-</button>
                                                }
                                            </div>
                                            <input type="text" class="form-control text-center" value="@item.Quantidade" readonly>
                                            <div class="input-group-append">
                                                @if (item.QuantidadeEstoque > item.Quantidade)
                                                {
                                                    @using (Html.BeginForm("AdicionarItem", "Home", FormMethod.Post))
                                                    {
                                                        <input type="hidden" name="id" value="@item.Codbarras">
                                                        <input type="hidden" name="quantidade" value="1">
                                                        <button type="submit" class="btn btn-default btn-acao-primario">+</button>
                                                    }
                                                }
                                                else
                                                {
                                                    <button type="button" class="btn btn-default btn-acao-primario" disabled>+</button>
                                                    <p class="text-danger mt-1">Itens no limite</p>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="price-wrap">
                                            <var class="price">@subTotal.ToString("C")</var>
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-outline-danger" onclick="confirmRemove('@item.Codbarras')">× Remover</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <div class="total-value">
                        Valor Total: @total.ToString("C")
                    </div>
                }
            </div>
        </div>
    </section>
    <br />
</div>

<div class="container" id="checkout-button">
    <br />
    <div class="row">
        <div class="col-md-12 text-center">
            Deseja adicionar outro item? <a asp-controller="Home" asp-action="FrontPage">Clique aqui</a> para continuar
        </div>
        <br />
        <div class="offset-md-4 col-md-4" style="display: @(!Model.Any() ? "none" : "block")">
            <a class="btn btn-outline-primary btn-continuar-comprando" asp-action="SalvarCarrinho" asp-controller="Home">
                Finalizar a compra
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    function confirmRemove(id) {
        Swal.fire({
            title: 'Você tem certeza?',
            text: 'Deseja remover este item do carrinho?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, remover!',
            cancelButtonText: 'Não, cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '@Url.Action("RemoverItem", "Home")',
                    type: 'POST',
                    data: { id: id },
                    success: function (response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            Swal.fire('Erro', 'Não foi possível remover o item. Tente novamente.', 'error');
                        }
                    }
                });
            }
        });
    }
</script>

